/*! PolySonic 2015-02-26 */
document.querySelector("#tmpl").addEventListener("template-bound",function(){"use strict";this.service=analytics.getService("PolySonic"),this.tracker=this.service.getTracker("UA-50154238-6"),this.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,this.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.OIDBTransaction||window.msIDBTransaction,this.dbVersion=1,this.request=this.indexedDB.open("albumInfo",this.dbVersion),this.request.onerror=function(){console.log("Error creating/accessing IndexedDB database")},this.request.onsuccess=function(){if(console.log("Success creating/accessing IndexedDB database"),this.db=this.request.result,this.db.setVersion&&this.db.version!==this.dbVersion){var a=this.db.setVersion(this.dbVersion);a.onsuccess=function(){this.createObjectStore(this.db)}}}.bind(this),this.request.onupgradeneeded=function(a){this.createObjectStore(a.target.result)}.bind(this),this.createObjectStore=function(a){console.log("Creating objectStore"),a.createObjectStore("albumInfo")},this.getImageForPlayer=function(a){var b=document.querySelector("#coverArt"),c=document.querySelector("#playNotify");b.style.backgroundImage="url('"+a+"')",c.icon=a},this.defaultPlayImage=function(){var a=document.querySelector("#coverArt"),b=document.querySelector("#playNotify");a.style.backgroundImage="url('images/default-cover-art.png')",b.icon="images/default-cover-art.png"},this.playlist=[],this.page=this.page||0,this.pageLimit=!1,this.sortTypes=[{sort:"newest",name:"Newest"},{sort:"frequent",name:"Frequent"},{sort:"alphabeticalByName",name:"By Title"},{sort:"alphabeticalByArtist",name:"By Artist"},{sort:"recent",name:"Recently Played"}],this.closeDrawer=function(){var a=this.$.panel;a.closeDrawer()},this.appScroller=function(){return this.$.headerPanel.scroller},this.scrollerPos=0,this.setScrollerPos=function(){var a=this.appScroller();this.scrollerPos=a.scrollTop},this.fixScroller=function(a){var b=this.appScroller();"core-animated-pages-transition-end"===a.type&&"main"===a.target.id&&0!==this.scrollerPos&&0===this.page?b.scrollTop=this.scrollerPos:"core-animated-pages-transition-prepare"===a.type&&"main"===a.target.id&&0!==b.scrollTop&&(b.scrollTop=0)},this.openSearch=function(){this.closeDrawer(),this.$.searchDialog.toggle()},this.xhrError=function(a){this.$.firstRun.toggle(),this.doToast("Error connecting to Subsonic"),console.log(a)}.bind(this),this.doXhr=function(a,b,c){var d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType=b,d.onload=c,d.onerror=this.xhrError,d.send()},this.showApp=function(){var a=document.querySelector("#loader").classList.contains("hide"),b=document.querySelector("#loader"),c=document.querySelector(".box");a||(b.classList.add("hide"),c.classList.add("hide"),this.fire("loaded"))},this.askUser=function(){this.$.analistics.toggle()},this.doSearch=function(){if(this.searchQuery){var a=this.url+"/rest/search3.view?u="+this.user+"&p="+this.pass+"&v="+this.version+"&c=PolySonic&f=json&query="+encodeURIComponent(this.searchQuery);this.doXhr(a,"json",function(a){if("ok"===a.target.response["subsonic-response"].status){var b=a.target.response["subsonic-response"];this.searchResults=[],this.searchResults.artist=b.searchResult3.artist,this.searchResults.album=[],this.searchResults.song=b.searchResult3.song,null!==b.searchResult3.album&&Array.prototype.forEach.call(b.searchResult3.album,function(a){var b={artist:a.artist,coverArt:a.coverArt,id:a.id,name:a.name,url:this.url,user:this.user,pass:this.pass,version:this.version,bitRate:this.bitRate,listMode:"cover"};this.searchResults.album.push(b)}.bind(this))}}.bind(this))}else this.doToast("No Query to Search")},this.doAction=function(){var a=this.appScroller();0===this.page&&0!==a.scrollTop&&(a.scrollTop=0),1===this.page&&this.showPlaylist(),3===this.page&&this.$.details.playAlbum()},this.sizePlayer=function(){var a=window.innerHeight-256+"px",b=window.innerWidth+"px",c=this.$.coverArt;c.style.width=b,c.style.height=a,c.style.backgroundSize=b},this.loadListeners=function(){var a=this.appScroller(),b=this.$.audio,c=chrome.app.window.current().isMaximized(),d=document.querySelectorAll(".max");c?Array.prototype.forEach.call(d,function(a){a.icon="flip-to-back"}):Array.prototype.forEach.call(d,function(a){a.icon="check-box-outline-blank"}),this.addEventListener("loaded",function(){chrome.storage.sync.get(function(a){this.service.getConfig().addCallback(function(b){void 0===a.analistics?this.askUser():b.setTrackingPermitted(a.analistics),this.allowAnalistics=function(){b.setTrackingPermitted(!0),chrome.storage.sync.set({analistics:!0})},this.disAllowAnalistics=function(){b.setTrackingPermitted(!1),chrome.storage.sync.set({analistics:!1})}}.bind(this))}.bind(this))}.bind(this)),this.position=a.scrollTop,a.onscroll=function(){var b=document.querySelector("animated-fab");0===this.page&&"off"!==b.state&&a.scrollTop<this.position?b.state="off":0===this.page&&"bottom"!==b.state&&a.scrollTop>this.position&&(b.state="bottom"),this.position=a.scrollTop}.bind(this),b.onended=this.nextTrack.bind(this),b.onerror=function(a){console.log(a),this.tracker.sendEvent("Audio Playback Error",a)}},this.loadData=function(){chrome.storage?chrome.storage.sync.get(function(a){if(void 0===a.url?document.querySelector("#firstRun").toggle():this.url=a.url,this.user=a.user,this.pass=a.pass,this.version=a.version,void 0!==a.version&&this.tracker.sendEvent("Loaded API Version",a.version),void 0===a.listMode?(chrome.storage.sync.set({listMode:"cover"}),this.listMode="cover",this.view="view-stream"):(this.listMode=a.listMode,this.view="cover"===a.listMode?"view-stream":"view-module"),void 0===a.bitRate?(chrome.storage.sync.set({bitRate:"320"}),this.bitRate="320"):this.bitRate=a.bitRate,void 0===a.sort&&(this.selected=""),void 0===a.querySize?(chrome.storage.sync.set({querySize:40}),this.querySize=40):this.querySize=a.querySize,void 0!==a.volume&&(this.volume=a.volume),this.url&&this.user&&this.pass&&this.version){var b=this.url+"/rest/ping.view?u="+this.user+"&p="+this.pass+"&v="+this.version+"&c=PolySonic&f=json";this.doXhr(b,"json",function(a){if(200===a.target.status){var b=a.target.response["subsonic-response"];"ok"===b.status?this.$.wall.doAjax():(this.$.firstRun.toggle(),this.doToast("Error Connecting to Subsonic"))}else this.$.firstRun.toggle(),this.doToast("Error Connecting to Subsonic")}.bind(this))}}.bind(this)):this.tracker.sendEvent("Error","Failed to load Storage")},this.doToast=function(a){var b=document.querySelector("#toast");b.text=a,b.show()},this.playAudio=function(a,b,c,d){var e=document.querySelector("#audio"),f=document.querySelector("#playNotify");""===a?(this.currentPlaying=b,f.title=b):(this.currentPlaying=a+" - "+b,f.title=a+" - "+b),e.src=c,e.play(),f.icon=d,f.show()},this.playThis=function(a,b,c){var d;d=""===c.attributes.artist.value?this.url+"/rest/stream.view?u="+this.user+"&p="+this.pass+"&v="+this.version+"&c=PolySonic&format=raw&estimateContentLength=true&id="+c.attributes.ident.value:this.url+"/rest/stream.view?u="+this.user+"&p="+this.pass+"&v="+this.version+"&c=PolySonic&maxBitRate="+this.bitRate+"&id="+c.attributes.ident.value,this.playAudio(c.attributes.artist.value,c.attributes.title.value,d,c.attributes.cover.value),c.attributes.cover.value?this.getImageForPlayer(c.attributes.cover.value):this.defaultPlayImage()},this.playNext=function(a){var b;this.playlist[a]?(b=""===this.playlist[a].artist?this.url+"/rest/stream.view?u="+this.user+"&p="+this.pass+"&v="+this.version+"&c=PolySonic&format=raw&estimateContentLength=true&id="+this.playlist[a].id:this.url+"/rest/stream.view?u="+this.user+"&p="+this.pass+"&v="+this.version+"&c=PolySonic&maxBitRate="+this.bitRate+"&id="+this.playlist[a].id,this.playAudio(this.playlist[a].artist,this.playlist[a].title,b,this.playlist[a].cover),this.playing=a,this.playlist[a].cover?this.getImageForPlayer(this.playlist[a].cover):this.defaultPlayImage()):this.clearPlayer()},this.nextTrack=function(){var a=this.playing+1;this.playNext(a)},this.lastTrack=function(){var a=this.playing-1;this.playNext(a)},this.toggleWall=function(){var a=this.$.wall;"cover"===a.listMode?(a.listMode="list",this.view="view-module",chrome.storage.sync.set({listMode:"list"})):(a.listMode="cover",this.view="view-stream",chrome.storage.sync.set({listMode:"cover"}))},this.clearPlayer=function(){console.log("playlist cleared"),this.page=0,this.src="",this.playlist=[]},this.back2List=function(){this.page=0,this.$.wall.listModeChanged()},this.nowPlaying=function(){this.setScrollerPos(),this.page=1},this.playPause=function(){var a=this.$.audio;a.paused?a.play():a.pause()},this.minimize=function(){chrome.app.window.current().minimize()},this.maximize=function(){var a=chrome.app.window.current().isMaximized(),b=document.querySelectorAll(".max");a?(Array.prototype.forEach.call(b,function(a){a.icon="check-box-outline-blank"}),chrome.app.window.current().restore()):(Array.prototype.forEach.call(b,function(a){a.icon="flip-to-back"}),chrome.app.window.current().maximize())},this.close=function(){window.close()},this.progressClick=function(a){var b=this.$.audio,c=a.x/window.innerWidth,d=b.duration-(b.duration-b.duration*c),e=this.$.progress;e.value=100*c,b.currentTime=d},this.selectAction=function(a,b,c){var d=this.$.wall;d.sort=c.attributes.i.value,this.closeDrawer()},this.getPodcast=function(){var a=this.$.wall;this.closeDrawer(),a.getPodcast()},this.getStarred=function(){var a=this.$.wall;this.closeDrawer(),a.getStarred()},this.getArtist=function(){var a=this.$.wall;this.closeDrawer(),a.getArtist()},this.toggleVolume=function(){var a=this.$.volumeDialog;a.toggle()},this.showPlaylist=function(){var a=this.$.playlistDialog;a.toggle()},this.openPanel=function(){var a=this.$.panel;a.openDrawer()},this.gotoSettings=function(){this.page=2,this.closeDrawer()},this.volUp=function(){return this.volume<100&&(this.volume=this.volume+10),this.volume},this.volDown=function(){return this.volume>0&&(this.volume=this.volume-10),this.volume},this.clearPlaylist=function(){this.playlist=null,this.playlist=[]},this.loadListeners(),this.loadData(),this.sizePlayer(),setInterval(function(){var a,b=this.$.audio,c=this.$.avIcon,d=Math.round(b.currentTime/b.duration*100*100)/100,e=Math.floor(b.currentTime/60),f=Math.round(b.currentTime-60*e),g=Math.floor(b.duration/60),h=Math.round(b.duration-60*g);b.paused?(this.isNowPlaying=!1,c.icon="av:play-arrow"):(c.icon="av:pause",this.isNowPlaying=!0,b.duration?(this.playTime=e+":"+("0"+f).slice(-2)+" / "+g+":"+("0"+h).slice(-2),a=b.buffered.end(0)/b.duration*100,this.progress=d,this.buffer=a):(this.playTime=e+":"+("0"+f).slice(-2)+" / ?:??",this.progress=0,this.buffer=0))}.bind(this),200),chrome.commands.onCommand.addListener(function(a){var b=document.querySelector("#audio");"playPauseMediaKey"===a?this.playPause():b.paused||"nextTrackMediaKey"!==a?b.paused||"lastTrackMediaKey"!==a?b.paused||"nextTrack"!==a?b.paused||"lastTrack"!==a?"playPause"===a?this.playPause():"volUp"===a?this.volUp():"volDown"===a&&this.volDown():this.lastTrack():this.nextTrack():this.lastTrack():this.nextTrack()}.bind(this))});
