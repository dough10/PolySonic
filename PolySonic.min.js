/*! PolySonic 2015-02-17 */
function sessionListener(a){session=a,0!=session.media.length&&onMediaDiscovered("onRequestSessionSuccess",session.media[0])}function receiverListener(a){a===chrome.cast.ReceiverAvailability.AVAILABLE&&console.log(a)}function onInitSuccess(){console.log("chromecast sender Init Successful")}function onError(a){console.log(a)}function onLaunchError(a){console.log(a)}function onRequestSessionSuccess(a){session=a}function onMediaDiscovered(a){console.log(a)}function onMediaDiscovered(a,b){currentMedia=b}initializeCastApi=function(){var a=new chrome.cast.SessionRequest(chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID),b=new chrome.cast.ApiConfig(a,sessionListener,receiverListener);chrome.cast.initialize(b,onInitSuccess,onError)},window.__onGCastApiAvailable=function(a,b){a?initializeCastApi():console.log(b)},document.querySelector("#tmpl").addEventListener("template-bound",function(){"use strict";this.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,this.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.OIDBTransaction||window.msIDBTransaction,this.dbVersion=1,this.request=this.indexedDB.open("albumInfo",this.dbVersion),this.request.onerror=function(){console.log("Error creating/accessing IndexedDB database")},this.request.onsuccess=function(){if(console.log("Success creating/accessing IndexedDB database"),this.db=this.request.result,this.db.setVersion&&this.db.version!==this.dbVersion){var a=this.db.setVersion(this.dbVersion);a.onsuccess=function(){this.createObjectStore(this.db)}}}.bind(this),this.chromecastSend=function(){var a=this.$.audio.src,b=new chrome.cast.media.MediaInfo(a),c=new chrome.cast.media.LoadRequest(b);session.loadMedia(c,onMediaDiscovered.bind(this,"loadMedia"),onMediaError)},this.request.onupgradeneeded=function(a){this.createObjectStore(a.target.result)}.bind(this),this.createObjectStore=function(a){console.log("Creating objectStore"),a.createObjectStore("albumInfo")},this.getImageForPlayer=function(a){var b=document.querySelector("#coverArt"),c=document.querySelector("#playNotify");b.style.backgroundImage="url('"+a+"')",c.icon=a},this.defaultPlayImage=function(){var a=document.querySelector("#coverArt"),b=document.querySelector("#playNotify");a.style.backgroundImage="url('images/default-cover-art.png')",b.icon="images/default-cover-art.png"},this.playlist=[],this.page=this.page||0,this.pageLimit=!1,this.sortTypes=[{sort:"newest",name:"Newest"},{sort:"frequent",name:"Frequent"},{sort:"alphabeticalByName",name:"By Title"},{sort:"alphabeticalByArtist",name:"By Artist"},{sort:"recent",name:"Recently Played"}],this.closeDrawer=function(){var a=document.querySelector("#panel");a.closeDrawer()},this.appScroller=function(){return document.querySelector("#headerPanel").scroller},this.scrollerPos=0,this.setScrollerPos=function(){var a=this.appScroller();this.scrollerPos=a.scrollTop},this.fixScroller=function(){var a=this.appScroller();0!==this.scrollerPos&&0===this.page&&(a.scrollTop=this.scrollerPos),3===this.page&&(a.scrollTop=0)},this.topOfPage=function(){var a=this.appScroller();0!==a.scrollTop&&(a.scrollTop=0)},this.sizePlayer=function(){var a=window.innerHeight-256+"px",b=window.innerWidth+"px",c=document.querySelector("#coverArt");c.style.width=b,c.style.height=a,c.style.backgroundSize=b},this.loadListeners=function(){var a=this.appScroller(),b=document.querySelector("#audio"),c=chrome.app.window.current().isMaximized(),d=document.querySelectorAll(".max"),e=document.querySelector("#wall");c?Array.prototype.forEach.call(d,function(a){a.icon="flip-to-back"}):Array.prototype.forEach.call(d,function(a){a.icon="check-box-outline-blank"}),this.position=a.scrollTop,a.onscroll=function(){var b=a.scrollTop/(a.scrollHeight-a.offsetHeight)*100,c=document.querySelector("animated-fab");0===this.page&&"off"!==c.state&&a.scrollTop<this.position?c.state="off":0===this.page&&"bottom"!==c.state&&a.scrollTop>this.position&&(c.state="bottom"),this.position=a.scrollTop,0===this.page&&b>80&&!this.pageLimit&&e.loadMore()}.bind(this),window.onresize=this.sizePlayer,b.onended=this.nextTrack.bind(this)},this.loadData=function(){chrome.storage?chrome.storage.sync.get(function(a){if(void 0===a.url?document.querySelector("#firstRun").toggle():this.url=a.url,this.user=a.user,this.pass=a.pass,this.version=a.version,void 0===a.listMode?(chrome.storage.sync.set({listMode:"cover"}),this.listMode="cover",this.view="view-stream"):(this.listMode=a.listMode,this.view="cover"===a.listMode?"view-stream":"view-module"),void 0===a.bitRate?(chrome.storage.sync.set({bitRate:"320"}),this.bitRate="320"):this.bitRate=a.bitRate,void 0===a.sort&&(this.selected=""),void 0===a.querySize){var b,c=screen.width+"x"+screen.height;b="1920x1080"===c?40:20,chrome.storage.sync.set({querySize:b}),this.querySize=b}else this.querySize=a.querySize;console.log("Query Size = "+this.querySize),void 0!==a.volume&&(this.volume=a.volume),setTimeout(function(){if(this.url&&this.user&&this.pass&&this.version){var a=document.querySelector("#wall");a.doAjax()}}.bind(this),100)}.bind(this)):console.log("no chrome storage")},this.systemNotify=function(a,b,c){var d=document.querySelector("#playNotify");d.title=a+" - "+b,d.icon=c,d.show()},this.doToast=function(a){var b=document.querySelector("#toast");b.text=a,b.show()},this.dismissToast=function(){var a=document.querySelector("#toast");a.dismiss()},this.playAudio=function(a,b,c){var d=document.querySelector("#audio");this.currentPlaying=a+" - "+b,d.src=c,d.play()},this.playThis=function(a,b,c){var d=this.url+"/rest/stream.view?u="+this.user+"&p="+this.pass+"&v=1.10.2&c=PolySonic&f=json&maxBitRate="+this.bitRate+"&id="+c.attributes.ident.value;this.systemNotify(c.attributes.artist.value,c.attributes.title.value,c.attributes.cover.value),this.playAudio(c.attributes.artist.value,c.attributes.title.value,d),void 0!==c.attributes.cover.value?this.getImageForPlayer(c.attributes.cover.value):this.defaultPlayImage()},this.nextTrack=function(){var a=this.playing+1,b=this.url+"/rest/stream.view?u="+this.user+"&p="+this.pass+"&v=1.10.2&c=PolySonic&f=json&maxBitRate="+this.bitRate+"&id="+this.playlist[a].id;this.playlist[a]?(this.playing=a,this.systemNotify(this.playlist[a].artist,this.playlist[a].title,this.playlist[a].cover),this.playAudio(this.playlist[a].artist,this.playlist[a].title,b),void 0!==this.playlist[a].cover?this.getImageForPlayer(this.playlist[a].cover):this.defaultPlayImage()):this.clearPlayer()},this.lastTrack=function(){var a=this.playing-1,b=this.url+"/rest/stream.view?u="+this.user+"&p="+this.pass+"&v=1.10.2&c=PolySonic&f=json&maxBitRate="+this.bitRate+"&id="+this.playlist[a].id;this.playlist[a]?(this.playing=a,this.systemNotify(this.playlist[a].artist,this.playlist[a].title,this.playlist[a].cover),this.playAudio(this.playlist[a].artist,this.playlist[a].title,b),void 0!==this.playlist[a].cover?this.getImageForPlayer(this.playlist[a].cover):this.defaultPlayImage()):this.clearPlayer()},this.toggleWall=function(){var a=document.querySelector("#wall");"cover"===a.listMode?(a.listMode="list",this.view="view-module",chrome.storage.sync.set({listMode:"list"})):(a.listMode="cover",this.view="view-stream",chrome.storage.sync.set({listMode:"cover"}))},this.clearPlayer=function(){this.page=0,this.src="",this.playlist=[]},this.back2List=function(){this.page=0,document.querySelector("#wall").listModeChanged()},this.nowPlaying=function(){this.setScrollerPos(),this.page=1},this.playPause=function(){var a=document.querySelector("#audio");a.paused?a.play():a.pause()},this.minimize=function(){chrome.app.window.current().minimize()},this.maximize=function(){var a=chrome.app.window.current().isMaximized(),b=document.querySelectorAll(".max");a?(Array.prototype.forEach.call(b,function(a){a.icon="check-box-outline-blank"}),chrome.app.window.current().restore()):(Array.prototype.forEach.call(b,function(a){a.icon="flip-to-back"}),chrome.app.window.current().maximize())},this.close=function(){window.close()},this.progressClick=function(a){var b=document.querySelector("#audio"),c=a.x/window.innerWidth,d=b.duration-(b.duration-b.duration*c);b.currentTime=d},this.selectAction=function(){var a=this.appScroller(),b=document.querySelector("#wall");b.sort=this.selected,this.closeDrawer(),setTimeout(function(){a.scrollTop=0},500)},this.getPodcast=function(){var a=this.appScroller(),b=document.querySelector("#wall");this.closeDrawer(),b.getPodcast(),setTimeout(function(){a.scrollTop=0},500)},this.getStarred=function(){var a=this.appScroller(),b=document.querySelector("#wall");this.closeDrawer(),b.getStarred(),setTimeout(function(){a.scrollTop=0},500)},this.getArtist=function(){var a=this.appScroller(),b=document.querySelector("#wall");this.closeDrawer(),b.getArtist(),setTimeout(function(){a.scrollTop=0},500)},this.toggleVolume=function(){var a=document.querySelector("#volumeDialog");a.toggle()},this.showPlaylist=function(){var a=document.querySelector("#playlistDialog");a.toggle()},this.openPanel=function(){var a=document.querySelector("#panel");a.openDrawer()},this.gotoSettings=function(){this.page=2,this.closeDrawer()},this.volUp=function(){return this.volume<100&&(this.volume=this.volume+10),this.volume},this.volDown=function(){return this.volume>0&&(this.volume=this.volume-10),this.volume},this.clearPlaylist=function(){this.playlist=[]},this.loadListeners(),this.loadData(),this.sizePlayer(),setInterval(function(){var a=document.querySelector("#audio"),b=document.querySelector("#avIcon"),c=document.querySelector("#progress"),d=Math.round(a.currentTime/a.duration*100*100)/100,e=Math.floor(a.currentTime/60),f=Math.round(a.currentTime-60*e),g=Math.floor(a.duration/60),h=Math.round(a.duration-60*g);a.paused?(this.isNowPlaying=!1,b.icon="av:play-arrow"):(b.icon="av:pause",this.isNowPlaying=!0,a.duration?(this.playTime=e+":"+("0"+f).slice(-2)+" / "+g+":"+("0"+h).slice(-2),c.value=d):(this.playTime=e+":"+("0"+f).slice(-2)+" / ?:??",c.value=0))}.bind(this),200),chrome.commands.onCommand.addListener(function(a){var b=document.querySelector("#audio");"playPauseMediaKey"===a?this.playPause():b.paused||"nextTrackMediaKey"!==a?b.paused||"lastTrackMediaKey"!==a?b.paused||"nextTrack"!==a?b.paused||"lastTrack"!==a?"playPause"===a?this.playPause():"volUp"===a?this.volUp():"volDown"===a&&this.volDown():this.lastTrack():this.nextTrack():this.lastTrack():this.nextTrack()}.bind(this))});
